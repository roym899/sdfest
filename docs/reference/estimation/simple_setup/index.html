
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://roym899.github.io/sdfest/reference/estimation/simple_setup/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>simple_setup - SDFEst</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sdfest.estimation.simple_setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="SDFEst" class="md-header__button md-logo" aria-label="SDFEst" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SDFEst
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              simple_setup
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/roym899/sdfest" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    roym899/sdfest
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="SDFEst" class="md-nav__button md-logo" aria-label="SDFEst" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    SDFEst
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/roym899/sdfest" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    roym899/sdfest
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Getting started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          differentiable_renderer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="differentiable_renderer" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          differentiable_renderer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1_1">
          scripts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="scripts" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          scripts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../differentiable_renderer/scripts/experiments/" class="md-nav__link">
        experiments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../differentiable_renderer/sdf_renderer/" class="md-nav__link">
        sdf_renderer
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          estimation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="estimation" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          estimation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../losses/" class="md-nav__link">
        losses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metrics/" class="md-nav__link">
        metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_3" type="checkbox" id="__nav_2_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2_3">
          scripts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="scripts" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_3">
          <span class="md-nav__icon md-icon"></span>
          scripts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/play_log/" class="md-nav__link">
        play_log
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/real_data/" class="md-nav__link">
        real_data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/rendering_evaluation/" class="md-nav__link">
        rendering_evaluation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          simple_setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        simple_setup
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup" class="md-nav__link">
    simple_setup
  </a>
  
    <nav class="md-nav" aria-label="simple_setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.NoDepthError" class="md-nav__link">
    NoDepthError
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline" class="md-nav__link">
    SDFPipeline
  </a>
  
    <nav class="md-nav" aria-label="SDFPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.generate_depth" class="md-nav__link">
    generate_depth()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.generate_mesh" class="md-nav__link">
    generate_mesh()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../synthetic/" class="md-nav__link">
        synthetic
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          initialization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="initialization" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          initialization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_1" type="checkbox" id="__nav_2_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_1">
          datasets
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="datasets" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_1">
          <span class="md-nav__icon md-icon"></span>
          datasets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/datasets/dataset_utils/" class="md-nav__link">
        dataset_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/datasets/generated_dataset/" class="md-nav__link">
        generated_dataset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/datasets/nocs_dataset/" class="md-nav__link">
        nocs_dataset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/datasets/nocs_utils/" class="md-nav__link">
        nocs_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/datasets/redwood_dataset/" class="md-nav__link">
        redwood_dataset
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/pointnet/" class="md-nav__link">
        pointnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/pointset_utils/" class="md-nav__link">
        pointset_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/quaternion_utils/" class="md-nav__link">
        quaternion_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_5" type="checkbox" id="__nav_2_3_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_5">
          scripts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="scripts" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_5">
          <span class="md-nav__icon md-icon"></span>
          scripts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/scripts/train/" class="md-nav__link">
        train
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/sdf_pose_network/" class="md-nav__link">
        sdf_pose_network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/sdf_utils/" class="md-nav__link">
        sdf_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/so3grid/" class="md-nav__link">
        so3grid
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../initialization/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          vae
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="vae" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          vae
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5_1" type="checkbox" id="__nav_2_5_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5_1">
          scripts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="scripts" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_5_1">
          <span class="md-nav__icon md-icon"></span>
          scripts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/scripts/benchmark/" class="md-nav__link">
        benchmark
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/scripts/process_shapenet/" class="md-nav__link">
        process_shapenet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/scripts/train/" class="md-nav__link">
        train
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/scripts/visualizer/" class="md-nav__link">
        visualizer
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/sdf_dataset/" class="md-nav__link">
        sdf_dataset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/sdf_utils/" class="md-nav__link">
        sdf_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/sdf_vae/" class="md-nav__link">
        sdf_vae
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/torch_utils/" class="md-nav__link">
        torch_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vae/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup" class="md-nav__link">
    simple_setup
  </a>
  
    <nav class="md-nav" aria-label="simple_setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.NoDepthError" class="md-nav__link">
    NoDepthError
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline" class="md-nav__link">
    SDFPipeline
  </a>
  
    <nav class="md-nav" aria-label="SDFPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.generate_depth" class="md-nav__link">
    generate_depth()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdfest.estimation.simple_setup.SDFPipeline.generate_mesh" class="md-nav__link">
    generate_mesh()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/roym899/sdfest/edit/main/docs/sdfest/estimation/simple_setup.py" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>simple_setup</h1>

<div class="doc doc-object doc-module">



<h2 id="sdfest.estimation.simple_setup" class="doc doc-heading">
          <span class="doc doc-object-name doc-module-name">sdfest.estimation.simple_setup</span>


</h2>

  <div class="doc doc-contents first">
  
      <p>Modular SDF pose and shape estimation in depth images.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="sdfest.estimation.simple_setup.NoDepthError" class="doc doc-heading">
        <span class="doc doc-object-name doc-class-name">NoDepthError</span>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>ValueError</code></p>

  
      <p>Raised when there is no depth data left after preprocessing.</p>


        <details class="quote">
          <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">NoDepthError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when there is no depth data left after preprocessing.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="sdfest.estimation.simple_setup.SDFPipeline" class="doc doc-heading">
        <span class="doc doc-object-name doc-class-name">SDFPipeline</span>


</h3>


  <div class="doc doc-contents ">

  
      <p>SDF pose and shape estimation pipeline.</p>


        <details class="quote">
          <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SDFPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;SDF pose and shape estimation pipeline.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load and initialize the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span> <span class="o">=</span> <span class="n">SDFPoseNet</span><span class="p">(</span>
            <span class="n">INIT_MODULE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;backbone_type&quot;</span><span class="p">]](</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;backbone&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">INIT_MODULE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head_type&quot;</span><span class="p">]](</span>
                <span class="n">shape_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;latent_size&quot;</span><span class="p">],</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">load_model_weights</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_url&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">SDFVAE</span><span class="p">(</span>
            <span class="n">sdf_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">latent_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;latent_size&quot;</span><span class="p">],</span>
            <span class="n">encoder_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">],</span>
            <span class="n">decoder_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">load_model_weights</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_url&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sdf</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">i_s</span><span class="p">:</span> <span class="n">render_depth_gpu</span><span class="p">(</span>
            <span class="n">sdf</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">i_s</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_parse_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse config dict.</span>

<span class="sd">        This function makes sure that all required keys are available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vae&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;vae&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;vae&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;result_selection_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;last_iteration&quot;</span>
        <span class="p">)</span>  <span class="c1"># last_iteration | best_inlier_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relative_inlier_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;relative_inlier_threshold&quot;</span><span class="p">,</span> <span class="mf">0.03</span>
        <span class="p">)</span>  <span class="c1"># relative depth error threshold for pixel to be considered inlier</span>
        <span class="k">if</span> <span class="s2">&quot;far_field&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_far_field</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;far_field&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;far_field&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_view_losses</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">depth_estimate</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sdf</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="c1"># depth l1</span>
        <span class="n">overlap_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_input</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">depth_estimate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">depth_error</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depth_estimate</span> <span class="o">-</span> <span class="n">depth_input</span><span class="p">)</span>
        <span class="c1"># max_depth_error = 0.05</span>
        <span class="c1"># depth_outlier_mask = depth_error &gt; max_depth_error</span>
        <span class="c1"># depth_mask = overlap_mask &amp; ~depth_outlier_mask</span>
        <span class="c1"># depth_error[~overlap_mask] = 0</span>
        <span class="n">loss_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">depth_error</span><span class="p">[</span><span class="n">overlap_mask</span><span class="p">])</span>

        <span class="c1"># pointcloud l1</span>
        <span class="n">pointcloud_obs</span> <span class="o">=</span> <span class="n">pointset_utils</span><span class="o">.</span><span class="n">depth_to_pointcloud</span><span class="p">(</span>
            <span class="n">depth_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">pointcloud_error</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">pc_loss</span><span class="p">(</span>
            <span class="n">pointcloud_obs</span><span class="p">,</span>
            <span class="n">position</span><span class="p">,</span>
            <span class="n">orientation</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">sdf</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">loss_pc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pointcloud_error</span><span class="p">))</span>

        <span class="c1"># nearest neighbor l1</span>
        <span class="c1"># pointcloud_outliers = pointset_utils.depth_to_pointcloud(</span>
        <span class="c1">#     depth_estimate, self.cam, normalize=False, mask=depth_outlier_mask</span>
        <span class="c1"># )</span>

        <span class="n">loss_nn</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># if pointcloud_outliers.shape[0] != 0:</span>
        <span class="c1"># pass</span>
        <span class="c1"># loss_nn += 0</span>
        <span class="c1"># # TODO different gradients for point cloud (not derived by renderer)</span>
        <span class="c1"># outlier_nn_d = losses.nn_loss(pointcloud_outliers, pointcloud_obs)</span>
        <span class="c1"># # only use positive, because sqrt is not differentiable at 0</span>
        <span class="c1"># outlier_nn_d = outlier_nn_d[outlier_nn_d &gt; 0]</span>
        <span class="c1"># loss_nn = loss_nn + torch.mean(torch.sqrt(outlier_nn_d))</span>

        <span class="k">return</span> <span class="n">loss_depth</span><span class="p">,</span> <span class="n">loss_pc</span><span class="p">,</span> <span class="n">loss_nn</span>

    <span class="k">def</span> <span class="nf">_compute_point_constraint_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute loss for point constraint if specified.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss_point_constraint</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">point_constraint_loss</span><span class="p">(</span>
                <span class="n">orientation_q</span><span class="o">=</span><span class="n">orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">loss_point_constraint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">orientation</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_inlier_ratio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">depth_estimate</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute ratio of pixels with small relative depth error.&quot;&quot;&quot;</span>
        <span class="n">rel_depth_error</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depth_input</span> <span class="o">-</span> <span class="n">depth_estimate</span><span class="p">)</span> <span class="o">/</span> <span class="n">depth_input</span>
        <span class="n">inlier_mask</span> <span class="o">=</span> <span class="n">rel_depth_error</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_inlier_threshold</span>
        <span class="n">inliers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">inlier_mask</span><span class="p">)</span>
        <span class="n">valid_depth_pixels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">depth_input</span><span class="p">)</span>
        <span class="n">inlier_ratio</span> <span class="o">=</span> <span class="n">inliers</span> <span class="o">/</span> <span class="n">valid_depth_pixels</span>
        <span class="k">return</span> <span class="n">inlier_ratio</span>

    <span class="k">def</span> <span class="nf">_update_best_estimate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">depth_estimate</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">latent_shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the best current estimate by keeping track of inlier ratio.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Inlier ratio of this configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inlier_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_inlier_ratio</span><span class="p">(</span><span class="n">depth_input</span><span class="p">,</span> <span class="n">depth_estimate</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_inlier_ratio</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">inlier_ratio</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_inlier_ratio</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_inlier_ratio</span> <span class="o">=</span> <span class="n">inlier_ratio</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_position</span> <span class="o">=</span> <span class="n">position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_orientation</span> <span class="o">=</span> <span class="n">orientation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_scale</span> <span class="o">=</span> <span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_latent_shape</span> <span class="o">=</span> <span class="n">latent_shape</span>
        <span class="k">return</span> <span class="n">inlier_ratio</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">color_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">camera_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">camera_orientations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shape_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">animation_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Infer pose, size and latent representation from depth and mask.</span>

<span class="sd">        If multiple images are passed the cameras are assumed to be fixed.</span>
<span class="sd">        All tensors should be on the same device as the pipeline.</span>

<span class="sd">        Batch dimension N must be provided either for all or none of the arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            depth_images:</span>
<span class="sd">                The depth map containing the distance along the camera&#39;s z-axis.</span>
<span class="sd">                Does not have to be masked, necessary preprocessing is done by pipeline.</span>
<span class="sd">                Will be masked and preprocessed in-place (pass copy if full depth is</span>
<span class="sd">                used afterwards).</span>
<span class="sd">                Shape (N, H, W) or (H, W) for a single depth image.</span>
<span class="sd">            masks:</span>
<span class="sd">                binary mask of the object to estimate, same shape as depth_images</span>
<span class="sd">            color_images:</span>
<span class="sd">                the color image (currently only used in visualization),</span>
<span class="sd">                shape (N, H, W, 3) or (H, W, 3), RGB, float, 0-1.</span>
<span class="sd">            visualize: Whether to visualize the intermediate steps and final result.</span>
<span class="sd">            camera_positions:</span>
<span class="sd">                position of camera in world coordinates for each image,</span>
<span class="sd">                if None, (0,0,0) will be assumed for all images,</span>
<span class="sd">                shape (N, 3) or (3,)</span>
<span class="sd">            camera_orientations:</span>
<span class="sd">                orientation of camera in world-frame as normalized quaternion,</span>
<span class="sd">                quaternion is in scalar-last convention,</span>
<span class="sd">                note, that this is the quaternion that transforms a point from camera</span>
<span class="sd">                to world-frame</span>
<span class="sd">                if None, (0,0,0,1) will be assumed for all images,</span>
<span class="sd">                shape (N, 4) or (4,)</span>
<span class="sd">            log_path:</span>
<span class="sd">                file path to write timestamps and intermediate steps to,</span>
<span class="sd">                no logging is performed if None</span>
<span class="sd">            shape_optimization:</span>
<span class="sd">                enable or disable shape optimization during iterative optimization</span>
<span class="sd">            animation_path:</span>
<span class="sd">                file path to write rendering and error visualizations to</span>
<span class="sd">            point_constraint:</span>
<span class="sd">                tuple of source point and rotated target point and weight</span>
<span class="sd">                a loss will be added that penalizes</span>
<span class="sd">                    weight * || rotation @ source - target ||_2</span>
<span class="sd">            prior_orientation_distribution:</span>
<span class="sd">                Prior distribution of orientations used for initialization.</span>
<span class="sd">                If None, distribution of initialization network will not be modified.</span>
<span class="sd">                Only supported for initialization network with discretized orientation</span>
<span class="sd">                representation.</span>
<span class="sd">                Output distribution of initialization network will be adjusted by</span>
<span class="sd">                multiplying with</span>
<span class="sd">                prior_orientation_distribution / training_orientation_distribution</span>
<span class="sd">                and renormalizing.</span>
<span class="sd">                Tensor of shape (N,C,) or (C,) for single image.</span>
<span class="sd">                C being the number of grid cells in the SO3Grid used by the</span>
<span class="sd">                initialization network.</span>
<span class="sd">            training_orientation_distribution:</span>
<span class="sd">                Distribution of orientations used for training initialization network.</span>
<span class="sd">                If None, equal probability for each cell will be assumed.</span>
<span class="sd">                Note this is only approximately the same as a uniform distribution.</span>
<span class="sd">                Only used if prior_orientation_distribution is provided.</span>
<span class="sd">                Tensor of shape (C,). C being the number of grid cells in the SO3Grid</span>
<span class="sd">                used by the initialization network. N not supported, since same</span>
<span class="sd">                training network (and hence distribution) is used independent of view.</span>

<span class="sd">        Returns:</span>
<span class="sd">            - 3D pose of SDF center in world frame, shape (1,3,)</span>
<span class="sd">            - Orientation as normalized quaternion, scalar-last convention, shape (1,4,)</span>
<span class="sd">            - Size of SDF as length of half-width, shape (1,)</span>
<span class="sd">            - Latent shape representation of the object, shape (1,latent_size,).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_inlier_ratio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span> <span class="o">=</span> <span class="n">point_constraint</span>

        <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_animation_folders</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># for logging</span>

        <span class="c1"># Add batch dimension if necessary</span>
        <span class="k">if</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">depth_images</span> <span class="o">=</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">color_images</span> <span class="o">=</span> <span class="n">color_images</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">camera_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">camera_positions</span> <span class="o">=</span> <span class="n">camera_positions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">camera_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">camera_orientations</span> <span class="o">=</span> <span class="n">camera_orientations</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prior_orientation_distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prior_orientation_distribution</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">prior_orientation_distribution</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># TODO assert all tensors have expected dimension</span>

        <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_inputs</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="n">depth_images</span><span class="p">,</span> <span class="n">color_images</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>

        <span class="n">n_imgs</span> <span class="o">=</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">camera_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">camera_positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">camera_orientations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">camera_orientations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">camera_orientations</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_depth</span><span class="p">(</span><span class="n">depth_images</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>

        <span class="c1"># store pointcloud without reconstruction</span>
        <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                    <span class="s2">&quot;depth_images&quot;</span><span class="p">:</span> <span class="n">depth_images</span><span class="p">,</span>
                    <span class="s2">&quot;color_images&quot;</span><span class="p">:</span> <span class="n">color_images</span><span class="p">,</span>
                    <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">masks</span><span class="p">,</span>
                    <span class="s2">&quot;color_images&quot;</span><span class="p">:</span> <span class="n">color_images</span><span class="p">,</span>
                    <span class="s2">&quot;camera_positions&quot;</span><span class="p">:</span> <span class="n">camera_positions</span><span class="p">,</span>
                    <span class="s2">&quot;camera_orientations&quot;</span><span class="p">:</span> <span class="n">camera_orientations</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Initialization</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">latent_shape</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nn_init</span><span class="p">(</span>
                <span class="n">depth_images</span><span class="p">,</span>
                <span class="n">camera_positions</span><span class="p">,</span>
                <span class="n">camera_orientations</span><span class="p">,</span>
                <span class="n">prior_orientation_distribution</span><span class="p">,</span>
                <span class="n">training_orientation_distribution</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                    <span class="s2">&quot;camera_positions&quot;</span><span class="p">:</span> <span class="n">camera_positions</span><span class="p">,</span>
                    <span class="s2">&quot;camera_orientations&quot;</span><span class="p">:</span> <span class="n">camera_orientations</span><span class="p">,</span>
                    <span class="s2">&quot;latent_shape&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
                    <span class="s2">&quot;scale_inv&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                    <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_preprocessed_inputs</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="n">depth_images</span><span class="p">)</span>

        <span class="c1"># Iterative optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">position</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="n">scale</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="n">orientation</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="n">latent_shape</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">fig_vis</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig_loss</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_ax</span><span class="p">,</span> <span class="n">inlier_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">depth_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pointcloud_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nn_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">point_constraint_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inlier_ratios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_losses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">opt_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">opt_vars</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">norm_orientation</span> <span class="o">=</span> <span class="n">orientation</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orientation</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="n">shape_optimization</span><span class="p">):</span>
                <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent_shape</span><span class="p">)</span>

            <span class="n">loss_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">loss_pc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">loss_nn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">depth_image</span><span class="p">,</span> <span class="n">camera_position</span><span class="p">,</span> <span class="n">camera_orientation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">depth_images</span><span class="p">,</span> <span class="n">camera_positions</span><span class="p">,</span> <span class="n">camera_orientations</span>
            <span class="p">):</span>
                <span class="c1"># transform object to camera frame</span>
                <span class="n">q_w2c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_invert</span><span class="p">(</span><span class="n">camera_orientation</span><span class="p">)</span>
                <span class="n">position_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span>
                    <span class="n">q_w2c</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">camera_position</span>
                <span class="p">)</span>
                <span class="n">orientation_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                    <span class="n">q_w2c</span><span class="p">,</span> <span class="n">norm_orientation</span>
                <span class="p">)</span>

                <span class="n">depth_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">view_loss_depth</span><span class="p">,</span> <span class="n">view_loss_pc</span><span class="p">,</span> <span class="n">view_loss_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_view_losses</span><span class="p">(</span>
                    <span class="n">depth_image</span><span class="p">,</span>
                    <span class="n">depth_estimate</span><span class="p">,</span>
                    <span class="n">position_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">orientation_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">loss_depth</span> <span class="o">=</span> <span class="n">loss_depth</span> <span class="o">+</span> <span class="n">view_loss_depth</span>
                <span class="n">loss_pc</span> <span class="o">=</span> <span class="n">loss_pc</span> <span class="o">+</span> <span class="n">view_loss_pc</span>
                <span class="n">loss_nn</span> <span class="o">=</span> <span class="n">loss_nn</span> <span class="o">+</span> <span class="n">view_loss_nn</span>

            <span class="n">loss_point_constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_point_constraint_loss</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;depth_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_depth</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pc_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_pc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nn_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_nn</span>
                <span class="o">+</span> <span class="n">loss_point_constraint</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">orientation</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orientation</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">inlier_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_best_estimate</span><span class="p">(</span>
                    <span class="n">depth_image</span><span class="p">,</span>
                    <span class="n">depth_estimate</span><span class="p">,</span>
                    <span class="n">position</span><span class="p">,</span>
                    <span class="n">orientation</span><span class="p">,</span>
                    <span class="n">scale</span><span class="p">,</span>
                    <span class="n">latent_shape</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
                <span class="n">depth_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_depth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="n">pointcloud_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_pc</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="n">nn_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_nn</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="n">point_constraint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_point_constraint</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="n">inlier_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inlier_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                <span class="n">total_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                        <span class="s2">&quot;latent_shape&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span>
                        <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
                        <span class="s2">&quot;scale_inv&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                        <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_current_state</span><span class="p">(</span>
                        <span class="n">depth_images</span><span class="p">,</span>
                        <span class="n">animation_path</span><span class="p">,</span>
                        <span class="n">camera_positions</span><span class="p">,</span>
                        <span class="n">camera_orientations</span><span class="p">,</span>
                        <span class="n">position</span><span class="p">,</span>
                        <span class="n">orientation</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                        <span class="n">sdf</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">visualize</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">q_w2c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_invert</span><span class="p">(</span><span class="n">camera_orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">position_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span>
                        <span class="n">q_w2c</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">camera_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">orientation_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                        <span class="n">q_w2c</span><span class="p">,</span> <span class="n">orientation</span>
                    <span class="p">)</span>

                    <span class="n">current_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position_c</span><span class="p">,</span> <span class="n">orientation_c</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span>
                    <span class="p">)</span>

                    <span class="n">depth_image</span> <span class="o">=</span> <span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">color_image</span> <span class="o">=</span> <span class="n">color_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">depth_image</span><span class="p">[</span><span class="n">depth_image</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">depth_image</span><span class="p">[</span><span class="n">depth_image</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                        <span class="c1"># show input image</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_image</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

                        <span class="c1"># show initial estimate</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                            <span class="n">current_depth</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
                        <span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># update iterative estimate</span>
                    <span class="c1"># axes[0, 2].clear()</span>
                    <span class="c1"># axes[0, 2].imshow(rendered_error.detach().cpu())</span>
                    <span class="c1"># axes[0, 2].set_title(&quot;depth_loss&quot;)</span>
                    <span class="c1"># axes[1, 2].clear()</span>
                    <span class="c1"># axes[1, 2].imshow(error_pc.detach().cpu())</span>
                    <span class="c1"># axes[1, 2].set_title(&quot;pointcloud_loss&quot;)</span>

                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depth_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Depth&quot;</span><span class="p">)</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pointcloud_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pointcloud&quot;</span><span class="p">)</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nn_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nearest Neighbor&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point_constraint_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Point constraint&quot;</span><span class="p">)</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                    <span class="n">inlier_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">inlier_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">inlier_ratios</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inlier Ratio&quot;</span><span class="p">)</span>
                    <span class="n">inlier_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">current_depth</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
                    <span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fig_loss</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                    <span class="n">fig_vis</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_loss</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_vis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_log_data</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_animations</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span> <span class="o">==</span> <span class="s2">&quot;last_iteration&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">latent_shape</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span> <span class="o">==</span> <span class="s2">&quot;best_inlier_ratio&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_best_position</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_best_orientation</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_best_scale</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_best_latent_shape</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Result selection strategy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span><span class="si">}</span><span class="s2"> is not&quot;</span>
                <span class="s2">&quot;supported.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add dictionary with associated timestamp to log data list.&quot;&quot;&quot;</span>
        <span class="n">new_log_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_log_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write current list of log data to file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># reset log</span>

    <span class="k">def</span> <span class="nf">generate_depth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate depth image representing positioned object.&quot;&quot;&quot;</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">depth</span>

    <span class="k">def</span> <span class="nf">generate_mesh</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">complete_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">synthetic</span><span class="o">.</span><span class="n">Mesh</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate mesh without pose.</span>

<span class="sd">        Currently only supports batch size 1.</span>

<span class="sd">        Args:</span>
<span class="sd">            latent: Latent shape descriptor, shape (1,L).</span>
<span class="sd">            scale:</span>
<span class="sd">                Relative scale of the signed distance field, (i.e., half-width),</span>
<span class="sd">                shape (1,).</span>
<span class="sd">            complete_mesh:</span>
<span class="sd">                If True, the SDF will be padded with positive values prior to converting</span>
<span class="sd">                it to a mesh. This ensures a watertight mesh is created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Generate mesh by decoding latent shape descriptor and scaling it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">complete_mesh</span><span class="p">:</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">sdf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span>
                    <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">spacing</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">s</span><span class="p">,</span>
                        <span class="n">s</span><span class="p">,</span>
                        <span class="n">s</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;iso_threshold&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">+</span> <span class="n">inc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># move origin to center</span>
                <span class="n">vertices</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>

                <span class="n">mesh</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="p">(</span>
                    <span class="n">vertices</span><span class="o">=</span><span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">vertices</span><span class="p">),</span>
                    <span class="n">triangles</span><span class="o">=</span><span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3iVector</span><span class="p">(</span><span class="n">faces</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">synthetic</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">rel_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_preprocess_depth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Preprocesses depth image based on segmentation mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            depth_images:</span>
<span class="sd">                the depth images to preprocess, will be modified in place,</span>
<span class="sd">                shape (N, H, W)</span>
<span class="sd">            masks: the masks used for preprocessing, same shape as depth_images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># shrink mask</span>
        <span class="c1"># masks = (</span>
        <span class="c1">#     -torch.nn.functional.max_pool2d(</span>
        <span class="c1">#         -masks.double(), kernel_size=9, stride=1, padding=4</span>
        <span class="c1">#     )</span>
        <span class="c1"># ).bool()</span>

        <span class="n">depth_images</span><span class="p">[</span><span class="o">~</span><span class="n">masks</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># set outside of depth to 0</span>

        <span class="c1"># remove data far away (should be based on what distances ocurred in training)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_far_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depth_images</span><span class="p">[</span><span class="n">depth_images</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_far_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># only consider available depth values for outlier detection</span>
        <span class="c1"># masks = torch.logical_and(masks, depth_images != 0)</span>

        <span class="c1"># depth_images =</span>

        <span class="c1"># remove outliers based on median</span>
        <span class="c1"># plt.imshow(depth_images[0].cpu().numpy())</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># for mask, depth_image in zip(masks, depth_images):</span>
        <span class="c1">#     median = torch.median(depth_image[mask])</span>
        <span class="c1">#     errors = torch.abs(depth_image[mask] - median)</span>

        <span class="c1">#     bins = 100</span>
        <span class="c1">#     hist = torch.histc(errors, bins=bins)</span>
        <span class="c1">#     print(hist)</span>
        <span class="c1">#     zero_indices = torch.nonzero(hist == 0)</span>
        <span class="c1">#     if len(zero_indices):</span>
        <span class="c1">#         threshold = zero_indices[0] / bins * errors.max()</span>
        <span class="c1">#         print(threshold)</span>
        <span class="c1">#         depth_image[torch.abs(depth_image - median) &gt; threshold] = 0</span>
        <span class="c1"># plt.imshow(depth_images[0].cpu().numpy())</span>
        <span class="c1"># plt.show()</span>

    <span class="k">def</span> <span class="nf">_nn_init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">camera_positions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">camera_orientations</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">prior_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate shape, pose, scale and orientation using initialization network.</span>

<span class="sd">        Args:</span>
<span class="sd">            depth_images: the preprocessed depth images, shape (N, H, W)</span>
<span class="sd">            camera_positions:</span>
<span class="sd">                position of camera in world coordinates for each image, shape (N, 3)</span>
<span class="sd">            camera_orientations:</span>
<span class="sd">                orientation of camera in world-frame as normalized quaternion,</span>
<span class="sd">                quaternion is in scalar-last convention, shape (N, 4)</span>
<span class="sd">            prior_orientation_distribution:</span>
<span class="sd">                Prior distribution of orientations used for initialization.</span>
<span class="sd">                If None, distribution of initialization network will not be modified.</span>
<span class="sd">                Only supported for initialization network with discretized orientation</span>
<span class="sd">                representation.</span>
<span class="sd">                Output distribution of initialization network will be adjusted by</span>
<span class="sd">                multiplying with</span>
<span class="sd">                prior_orientation_distribution / training_orientation_distribution</span>
<span class="sd">                and renormalizing.</span>
<span class="sd">                Tensor of shape (N,C,). C being the number of grid cells in the SO3Grid</span>
<span class="sd">                used by the initialization network.</span>
<span class="sd">            training_orientation_distribution:</span>
<span class="sd">                Distribution of orientations used for training initialization network.</span>
<span class="sd">                If None, equal probability for each cell will be assumed.</span>
<span class="sd">                Note this is only approximately the same as a uniform distribution.</span>
<span class="sd">                Only used if prior_orientation_distribution is provided.</span>
<span class="sd">                Tensor of shape (C,). C being the number of grid cells in the SO3Grid</span>
<span class="sd">                used by the initialization network.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple comprised of:</span>
<span class="sd">            - Latent shape representation of the object, shape (1, latent_size)</span>
<span class="sd">            - 3D pose of SDF center in camera frame, shape (1, 3)</span>
<span class="sd">            - Size of SDF as length of half-width, (1,)</span>
<span class="sd">            - Orientation of SDF as normalized quaternion (1,4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">prior_orientation_distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">][</span><span class="s2">&quot;orientation_repr&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;discretized&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;prior_orientation_distribution only supported for discretized &quot;</span>
                <span class="s2">&quot;orientation representation.&quot;</span>
            <span class="p">)</span>

        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">depth_image</span><span class="p">,</span> <span class="n">camera_orientation</span><span class="p">,</span> <span class="n">camera_position</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">depth_images</span><span class="p">,</span> <span class="n">camera_orientations</span><span class="p">,</span> <span class="n">camera_positions</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;backbone_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VanillaPointNet&quot;</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">pointset_utils</span><span class="o">.</span><span class="n">depth_to_pointcloud</span><span class="p">(</span>
                    <span class="n">depth_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NoDepthError</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;normalize_pose&quot;</span><span class="p">]:</span>
                    <span class="n">inp</span><span class="p">,</span> <span class="n">centroid</span> <span class="o">=</span> <span class="n">pointset_utils</span><span class="o">.</span><span class="n">normalize_points</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">depth_image</span>

            <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">latent_shape</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">orientation_repr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mean_shape&quot;</span><span class="p">]:</span>
                <span class="n">latent_shape</span> <span class="o">=</span> <span class="n">latent_shape</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">latent_shape</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">centroid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">+=</span> <span class="n">centroid</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">][</span><span class="s2">&quot;orientation_repr&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;discretized&quot;</span><span class="p">:</span>
                <span class="n">posterior_orientation_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">orientation_repr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">prior_orientation_distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">posterior_orientation_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_categorical_posterior</span><span class="p">(</span>
                        <span class="n">posterior</span><span class="o">=</span><span class="n">posterior_orientation_dist</span><span class="p">,</span>
                        <span class="n">prior</span><span class="o">=</span><span class="n">prior_orientation_distribution</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">train_prior</span><span class="o">=</span><span class="n">training_orientation_distribution</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">orientation_camera</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="o">.</span><span class="n">_head</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">index_to_quat</span><span class="p">(</span>
                        <span class="n">posterior_orientation_dist</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">][</span><span class="s2">&quot;orientation_repr&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;quaternion&quot;</span><span class="p">:</span>
                <span class="n">orientation_camera</span> <span class="o">=</span> <span class="n">orientation_repr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Orientation representation is not supported&quot;</span><span class="p">)</span>

            <span class="c1"># output are in camera frame, transform to world frame</span>
            <span class="n">position_world</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span><span class="n">camera_orientation</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">camera_position</span>
            <span class="p">)</span>
            <span class="n">orientation_world</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                <span class="n">camera_orientation</span><span class="p">,</span> <span class="n">orientation_camera</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_view&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">latent_shape</span><span class="p">,</span> <span class="n">position_world</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">orientation_world</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_view&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">][</span><span class="s2">&quot;orientation_repr&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;discretized&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;best&quot; init strategy only supported with discretized &#39;</span>
                        <span class="s2">&quot;orientation representation&quot;</span>
                    <span class="p">)</span>
                <span class="n">maximum</span> <span class="o">=</span> <span class="n">posterior_orientation_dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">maximum</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">maximum</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="n">latent_shape</span><span class="p">,</span> <span class="n">position_world</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">orientation_world</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;Only &quot;first&quot; and &quot;best&quot; strategies are currently supported&#39;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">best_result</span>

    <span class="k">def</span> <span class="nf">_generate_uniform_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a uniform quaternion.</span>

<span class="sd">        Following the method from K. Shoemake, Uniform Random Rotations, 1992.</span>

<span class="sd">        See: http://planning.cs.uiuc.edu/node198.html</span>

<span class="sd">        Returns:</span>
<span class="sd">            Uniformly distributed unit quaternion on the estimator&#39;s device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u2</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u2</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u3</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u3</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_animation_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create subfolders to store animation frames.&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>
        <span class="n">depth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">depth_path</span><span class="p">)</span>
        <span class="n">error_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;depth_error&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">error_path</span><span class="p">)</span>
        <span class="n">sdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;sdf&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sdf_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">animation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">color_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">instance_masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;color_input.png&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">color_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">depth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;depth_input.png&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">depth_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;mask.png&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">instance_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_preprocessed_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">animation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">depth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;preprocessed_depth_input.png&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">depth_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_current_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">animation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">camera_positions</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">camera_orientations</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale_inv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sdf</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q_w2c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_invert</span><span class="p">(</span><span class="n">camera_orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">position_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span>
            <span class="n">q_w2c</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">camera_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">orientation_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span><span class="n">q_w2c</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>
        <span class="n">current_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position_c</span><span class="p">,</span> <span class="n">orientation_c</span><span class="p">,</span> <span class="n">scale_inv</span><span class="p">)</span>
        <span class="n">depth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span><span class="si">:</span><span class="s2">06</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_depth</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">depth_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">error_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">current_depth</span> <span class="o">-</span> <span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">error_image</span><span class="p">[</span><span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_image</span><span class="p">[</span><span class="n">current_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;depth_error&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span><span class="si">:</span><span class="s2">06</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">error_image</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">error_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">unscaled_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_inv</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">sdf_utils</span><span class="o">.</span><span class="n">mesh_from_sdf</span><span class="p">(</span>
            <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">unscaled_threshold</span><span class="p">,</span>
            <span class="n">complete_mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">animation_path</span><span class="p">,</span> <span class="s2">&quot;sdf&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span><span class="si">:</span><span class="s2">06</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="p">)</span>

        <span class="c1"># map y -&gt; z; z -&gt; y</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">sdf_utils</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">plot_object</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">sdf_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_animations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sdf&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_error&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">frame_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">video_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.mp4&quot;</span><span class="p">)</span>
            <span class="n">ffmpeg</span><span class="o">.</span><span class="n">input</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frame_folder</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">),</span> <span class="n">pattern_type</span><span class="o">=</span><span class="s2">&quot;glob&quot;</span><span class="p">,</span> <span class="n">framerate</span><span class="o">=</span><span class="mi">30</span>
            <span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">video_name</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_adjust_categorical_posterior</span><span class="p">(</span>
        <span class="n">posterior</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">prior</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">train_prior</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Adjust categorical posterior distribution.</span>

<span class="sd">        Posterior is calculated with a train_prior</span>

<span class="sd">        Args:</span>
<span class="sd">            posterior:</span>
<span class="sd">                Posterior distribution computed assuming train_prior.</span>
<span class="sd">                Shape (..., K). K being number of categories.</span>
<span class="sd">            prior:</span>
<span class="sd">                The desired new prior distribution.</span>
<span class="sd">                Same shape as posterior.</span>
<span class="sd">            train_prior:</span>
<span class="sd">                The prior distribution used to compute the posterior.</span>
<span class="sd">                If None, equal probability for each category will be assumed.</span>
<span class="sd">                Same shape as posterior.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The categorical posterior, adjusted such that prior is prior, instead of</span>
<span class="sd">            train_prior.</span>
<span class="sd">            Same shape as posterior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">adjusted_posterior</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c1"># adjust if prior different from training</span>
        <span class="n">adjusted_posterior</span> <span class="o">*=</span> <span class="n">prior</span>
        <span class="k">if</span> <span class="n">train_prior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adjusted_posterior</span> <span class="o">/=</span> <span class="n">train_prior</span>
        <span class="n">adjusted_posterior</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span>
            <span class="n">adjusted_posterior</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">adjusted_posterior</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="sdfest.estimation.simple_setup.SDFPipeline.__init__" class="doc doc-heading">
        <span class="doc doc-object-name doc-function-name">__init__</span>


</h4>
<div class="highlight"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load and initialize the pipeline.</p>

  <table>
    <thead>
      <tr>
        <th><b>PARAMETER</b></th>
        <th><b>DESCRIPTION</b></th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td class="doc-param-details">
            <p>Configuration dictionary.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>dict</code>
                </span>
            </p>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load and initialize the pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span> <span class="o">=</span> <span class="n">SDFPoseNet</span><span class="p">(</span>
        <span class="n">INIT_MODULE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;backbone_type&quot;</span><span class="p">]](</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;backbone&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">INIT_MODULE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head_type&quot;</span><span class="p">]](</span>
            <span class="n">shape_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;latent_size&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">load_model_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_url&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_network</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">SDFVAE</span><span class="p">(</span>
        <span class="n">sdf_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">latent_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;latent_size&quot;</span><span class="p">],</span>
        <span class="n">encoder_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">],</span>
        <span class="n">decoder_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">load_model_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_url&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sdf</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">i_s</span><span class="p">:</span> <span class="n">render_depth_gpu</span><span class="p">(</span>
        <span class="n">sdf</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">i_s</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="sdfest.estimation.simple_setup.SDFPipeline.__call__" class="doc doc-heading">
        <span class="doc doc-object-name doc-function-name">__call__</span>


</h4>
<div class="highlight"><pre><span></span><code><span class="fm">__call__</span><span class="p">(</span>
    <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">color_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">camera_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">camera_orientations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shape_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">animation_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prior_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">training_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Infer pose, size and latent representation from depth and mask.</p>
<p>If multiple images are passed the cameras are assumed to be fixed.
All tensors should be on the same device as the pipeline.</p>
<p>Batch dimension N must be provided either for all or none of the arguments.</p>

  <table>
    <thead>
      <tr>
        <th><b>PARAMETER</b></th>
        <th><b>DESCRIPTION</b></th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>depth_images</code></td>
          <td class="doc-param-details">
            <p>The depth map containing the distance along the camera's z-axis.
Does not have to be masked, necessary preprocessing is done by pipeline.
Will be masked and preprocessed in-place (pass copy if full depth is
used afterwards).
Shape (N, H, W) or (H, W) for a single depth image.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>torch.<span title="torch.Tensor">Tensor</span></code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>masks</code></td>
          <td class="doc-param-details">
            <p>binary mask of the object to estimate, same shape as depth_images</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>torch.<span title="torch.Tensor">Tensor</span></code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>color_images</code></td>
          <td class="doc-param-details">
            <p>the color image (currently only used in visualization),
shape (N, H, W, 3) or (H, W, 3), RGB, float, 0-1.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>torch.<span title="torch.Tensor">Tensor</span></code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>visualize</code></td>
          <td class="doc-param-details">
            <p>Whether to visualize the intermediate steps and final result.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>bool</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>False</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>camera_positions</code></td>
          <td class="doc-param-details">
            <p>position of camera in world coordinates for each image,
if None, (0,0,0) will be assumed for all images,
shape (N, 3) or (3,)</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.Tensor">Tensor</span>]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>camera_orientations</code></td>
          <td class="doc-param-details">
            <p>orientation of camera in world-frame as normalized quaternion,
quaternion is in scalar-last convention,
note, that this is the quaternion that transforms a point from camera
to world-frame
if None, (0,0,0,1) will be assumed for all images,
shape (N, 4) or (4,)</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.Tensor">Tensor</span>]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>log_path</code></td>
          <td class="doc-param-details">
            <p>file path to write timestamps and intermediate steps to,
no logging is performed if None</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[str]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>shape_optimization</code></td>
          <td class="doc-param-details">
            <p>enable or disable shape optimization during iterative optimization</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>bool</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>True</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>animation_path</code></td>
          <td class="doc-param-details">
            <p>file path to write rendering and error visualizations to</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[str]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>point_constraint</code></td>
          <td class="doc-param-details">
            <p>tuple of source point and rotated target point and weight
a loss will be added that penalizes
    weight * || rotation @ source - target ||_2</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[torch.<span title="torch.Tensor">Tensor</span>]]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>prior_orientation_distribution</code></td>
          <td class="doc-param-details">
            <p>Prior distribution of orientations used for initialization.
If None, distribution of initialization network will not be modified.
Only supported for initialization network with discretized orientation
representation.
Output distribution of initialization network will be adjusted by
multiplying with
prior_orientation_distribution / training_orientation_distribution
and renormalizing.
Tensor of shape (N,C,) or (C,) for single image.
C being the number of grid cells in the SO3Grid used by the
initialization network.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.Tensor">Tensor</span>]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>training_orientation_distribution</code></td>
          <td class="doc-param-details">
            <p>Distribution of orientations used for training initialization network.
If None, equal probability for each cell will be assumed.
Note this is only approximately the same as a uniform distribution.
Only used if prior_orientation_distribution is provided.
Tensor of shape (C,). C being the number of grid cells in the SO3Grid
used by the initialization network. N not supported, since same
training network (and hence distribution) is used independent of view.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.Tensor">Tensor</span>]</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>None</code>
                </span>
            </p>
          </td>
        </tr>
    </tbody>
  </table>

  <table>
    <thead>
      <tr>
        <th><b>RETURNS</b></th>
        <th><b>DESCRIPTION</b></th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
              <span class="doc-returns-annotation">
                  <code>tuple</code>
              </span>
          </td>
          <td class="doc-returns-details">
            <ul>
<li>3D pose of SDF center in world frame, shape (1,3,)</li>
</ul>
          </td>
        </tr>
        <tr>
          <td>
              <span class="doc-returns-annotation">
                  <code>tuple</code>
              </span>
          </td>
          <td class="doc-returns-details">
            <ul>
<li>Orientation as normalized quaternion, scalar-last convention, shape (1,4,)</li>
</ul>
          </td>
        </tr>
        <tr>
          <td>
              <span class="doc-returns-annotation">
                  <code>tuple</code>
              </span>
          </td>
          <td class="doc-returns-details">
            <ul>
<li>Size of SDF as length of half-width, shape (1,)</li>
</ul>
          </td>
        </tr>
        <tr>
          <td>
              <span class="doc-returns-annotation">
                  <code>tuple</code>
              </span>
          </td>
          <td class="doc-returns-details">
            <ul>
<li>Latent shape representation of the object, shape (1,latent_size,).</li>
</ul>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">depth_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">color_images</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">visualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">camera_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">camera_orientations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shape_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">animation_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prior_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">training_orientation_distribution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Infer pose, size and latent representation from depth and mask.</span>

<span class="sd">    If multiple images are passed the cameras are assumed to be fixed.</span>
<span class="sd">    All tensors should be on the same device as the pipeline.</span>

<span class="sd">    Batch dimension N must be provided either for all or none of the arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        depth_images:</span>
<span class="sd">            The depth map containing the distance along the camera&#39;s z-axis.</span>
<span class="sd">            Does not have to be masked, necessary preprocessing is done by pipeline.</span>
<span class="sd">            Will be masked and preprocessed in-place (pass copy if full depth is</span>
<span class="sd">            used afterwards).</span>
<span class="sd">            Shape (N, H, W) or (H, W) for a single depth image.</span>
<span class="sd">        masks:</span>
<span class="sd">            binary mask of the object to estimate, same shape as depth_images</span>
<span class="sd">        color_images:</span>
<span class="sd">            the color image (currently only used in visualization),</span>
<span class="sd">            shape (N, H, W, 3) or (H, W, 3), RGB, float, 0-1.</span>
<span class="sd">        visualize: Whether to visualize the intermediate steps and final result.</span>
<span class="sd">        camera_positions:</span>
<span class="sd">            position of camera in world coordinates for each image,</span>
<span class="sd">            if None, (0,0,0) will be assumed for all images,</span>
<span class="sd">            shape (N, 3) or (3,)</span>
<span class="sd">        camera_orientations:</span>
<span class="sd">            orientation of camera in world-frame as normalized quaternion,</span>
<span class="sd">            quaternion is in scalar-last convention,</span>
<span class="sd">            note, that this is the quaternion that transforms a point from camera</span>
<span class="sd">            to world-frame</span>
<span class="sd">            if None, (0,0,0,1) will be assumed for all images,</span>
<span class="sd">            shape (N, 4) or (4,)</span>
<span class="sd">        log_path:</span>
<span class="sd">            file path to write timestamps and intermediate steps to,</span>
<span class="sd">            no logging is performed if None</span>
<span class="sd">        shape_optimization:</span>
<span class="sd">            enable or disable shape optimization during iterative optimization</span>
<span class="sd">        animation_path:</span>
<span class="sd">            file path to write rendering and error visualizations to</span>
<span class="sd">        point_constraint:</span>
<span class="sd">            tuple of source point and rotated target point and weight</span>
<span class="sd">            a loss will be added that penalizes</span>
<span class="sd">                weight * || rotation @ source - target ||_2</span>
<span class="sd">        prior_orientation_distribution:</span>
<span class="sd">            Prior distribution of orientations used for initialization.</span>
<span class="sd">            If None, distribution of initialization network will not be modified.</span>
<span class="sd">            Only supported for initialization network with discretized orientation</span>
<span class="sd">            representation.</span>
<span class="sd">            Output distribution of initialization network will be adjusted by</span>
<span class="sd">            multiplying with</span>
<span class="sd">            prior_orientation_distribution / training_orientation_distribution</span>
<span class="sd">            and renormalizing.</span>
<span class="sd">            Tensor of shape (N,C,) or (C,) for single image.</span>
<span class="sd">            C being the number of grid cells in the SO3Grid used by the</span>
<span class="sd">            initialization network.</span>
<span class="sd">        training_orientation_distribution:</span>
<span class="sd">            Distribution of orientations used for training initialization network.</span>
<span class="sd">            If None, equal probability for each cell will be assumed.</span>
<span class="sd">            Note this is only approximately the same as a uniform distribution.</span>
<span class="sd">            Only used if prior_orientation_distribution is provided.</span>
<span class="sd">            Tensor of shape (C,). C being the number of grid cells in the SO3Grid</span>
<span class="sd">            used by the initialization network. N not supported, since same</span>
<span class="sd">            training network (and hence distribution) is used independent of view.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - 3D pose of SDF center in world frame, shape (1,3,)</span>
<span class="sd">        - Orientation as normalized quaternion, scalar-last convention, shape (1,4,)</span>
<span class="sd">        - Size of SDF as length of half-width, shape (1,)</span>
<span class="sd">        - Latent shape representation of the object, shape (1,latent_size,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize optimization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_best_inlier_ratio</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span> <span class="o">=</span> <span class="n">point_constraint</span>

    <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_animation_folders</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># for logging</span>

    <span class="c1"># Add batch dimension if necessary</span>
    <span class="k">if</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">depth_images</span> <span class="o">=</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">color_images</span> <span class="o">=</span> <span class="n">color_images</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">camera_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">camera_positions</span> <span class="o">=</span> <span class="n">camera_positions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">camera_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">camera_orientations</span> <span class="o">=</span> <span class="n">camera_orientations</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prior_orientation_distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior_orientation_distribution</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">prior_orientation_distribution</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># TODO assert all tensors have expected dimension</span>

    <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_inputs</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="n">depth_images</span><span class="p">,</span> <span class="n">color_images</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>

    <span class="n">n_imgs</span> <span class="o">=</span> <span class="n">depth_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">camera_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">camera_positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">camera_orientations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">camera_orientations</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">camera_orientations</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_depth</span><span class="p">(</span><span class="n">depth_images</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>

    <span class="c1"># store pointcloud without reconstruction</span>
    <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                <span class="s2">&quot;depth_images&quot;</span><span class="p">:</span> <span class="n">depth_images</span><span class="p">,</span>
                <span class="s2">&quot;color_images&quot;</span><span class="p">:</span> <span class="n">color_images</span><span class="p">,</span>
                <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">masks</span><span class="p">,</span>
                <span class="s2">&quot;color_images&quot;</span><span class="p">:</span> <span class="n">color_images</span><span class="p">,</span>
                <span class="s2">&quot;camera_positions&quot;</span><span class="p">:</span> <span class="n">camera_positions</span><span class="p">,</span>
                <span class="s2">&quot;camera_orientations&quot;</span><span class="p">:</span> <span class="n">camera_orientations</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="c1"># Initialization</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">latent_shape</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nn_init</span><span class="p">(</span>
            <span class="n">depth_images</span><span class="p">,</span>
            <span class="n">camera_positions</span><span class="p">,</span>
            <span class="n">camera_orientations</span><span class="p">,</span>
            <span class="n">prior_orientation_distribution</span><span class="p">,</span>
            <span class="n">training_orientation_distribution</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                <span class="s2">&quot;camera_positions&quot;</span><span class="p">:</span> <span class="n">camera_positions</span><span class="p">,</span>
                <span class="s2">&quot;camera_orientations&quot;</span><span class="p">:</span> <span class="n">camera_orientations</span><span class="p">,</span>
                <span class="s2">&quot;latent_shape&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span>
                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
                <span class="s2">&quot;scale_inv&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_preprocessed_inputs</span><span class="p">(</span><span class="n">animation_path</span><span class="p">,</span> <span class="n">depth_images</span><span class="p">)</span>

    <span class="c1"># Iterative optimization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">position</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
    <span class="n">scale</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
    <span class="n">orientation</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
    <span class="n">latent_shape</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="n">fig_vis</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fig_loss</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_ax</span><span class="p">,</span> <span class="n">inlier_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">depth_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pointcloud_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nn_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">point_constraint_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inlier_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">opt_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">opt_vars</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="n">norm_orientation</span> <span class="o">=</span> <span class="n">orientation</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orientation</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="n">shape_optimization</span><span class="p">):</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent_shape</span><span class="p">)</span>

        <span class="n">loss_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">loss_pc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">loss_nn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">depth_image</span><span class="p">,</span> <span class="n">camera_position</span><span class="p">,</span> <span class="n">camera_orientation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">depth_images</span><span class="p">,</span> <span class="n">camera_positions</span><span class="p">,</span> <span class="n">camera_orientations</span>
        <span class="p">):</span>
            <span class="c1"># transform object to camera frame</span>
            <span class="n">q_w2c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_invert</span><span class="p">(</span><span class="n">camera_orientation</span><span class="p">)</span>
            <span class="n">position_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span>
                <span class="n">q_w2c</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">camera_position</span>
            <span class="p">)</span>
            <span class="n">orientation_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                <span class="n">q_w2c</span><span class="p">,</span> <span class="n">norm_orientation</span>
            <span class="p">)</span>

            <span class="n">depth_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">view_loss_depth</span><span class="p">,</span> <span class="n">view_loss_pc</span><span class="p">,</span> <span class="n">view_loss_nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_view_losses</span><span class="p">(</span>
                <span class="n">depth_image</span><span class="p">,</span>
                <span class="n">depth_estimate</span><span class="p">,</span>
                <span class="n">position_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">orientation_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">loss_depth</span> <span class="o">=</span> <span class="n">loss_depth</span> <span class="o">+</span> <span class="n">view_loss_depth</span>
            <span class="n">loss_pc</span> <span class="o">=</span> <span class="n">loss_pc</span> <span class="o">+</span> <span class="n">view_loss_pc</span>
            <span class="n">loss_nn</span> <span class="o">=</span> <span class="n">loss_nn</span> <span class="o">+</span> <span class="n">view_loss_nn</span>

        <span class="n">loss_point_constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_point_constraint_loss</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;depth_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_depth</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pc_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_pc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nn_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss_nn</span>
            <span class="o">+</span> <span class="n">loss_point_constraint</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">orientation</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">orientation</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">inlier_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_best_estimate</span><span class="p">(</span>
                <span class="n">depth_image</span><span class="p">,</span>
                <span class="n">depth_estimate</span><span class="p">,</span>
                <span class="n">position</span><span class="p">,</span>
                <span class="n">orientation</span><span class="p">,</span>
                <span class="n">scale</span><span class="p">,</span>
                <span class="n">latent_shape</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">depth_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_depth</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">pointcloud_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_pc</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">nn_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_nn</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">point_constraint_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_point_constraint</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">inlier_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inlier_ratio</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">total_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_data</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                    <span class="s2">&quot;latent_shape&quot;</span><span class="p">:</span> <span class="n">latent_shape</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
                    <span class="s2">&quot;scale_inv&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                    <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="n">orientation</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_current_state</span><span class="p">(</span>
                    <span class="n">depth_images</span><span class="p">,</span>
                    <span class="n">animation_path</span><span class="p">,</span>
                    <span class="n">camera_positions</span><span class="p">,</span>
                    <span class="n">camera_orientations</span><span class="p">,</span>
                    <span class="n">position</span><span class="p">,</span>
                    <span class="n">orientation</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span>
                    <span class="n">sdf</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">visualize</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">q_w2c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_invert</span><span class="p">(</span><span class="n">camera_orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">position_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_apply</span><span class="p">(</span>
                    <span class="n">q_w2c</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">camera_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">orientation_c</span> <span class="o">=</span> <span class="n">quaternion_utils</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                    <span class="n">q_w2c</span><span class="p">,</span> <span class="n">orientation</span>
                <span class="p">)</span>

                <span class="n">current_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position_c</span><span class="p">,</span> <span class="n">orientation_c</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span>
                <span class="p">)</span>

                <span class="n">depth_image</span> <span class="o">=</span> <span class="n">depth_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">color_image</span> <span class="o">=</span> <span class="n">color_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">depth_image</span><span class="p">[</span><span class="n">depth_image</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">depth_image</span><span class="p">[</span><span class="n">depth_image</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="c1"># show input image</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">depth_image</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

                    <span class="c1"># show initial estimate</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">current_depth</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
                    <span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># update iterative estimate</span>
                <span class="c1"># axes[0, 2].clear()</span>
                <span class="c1"># axes[0, 2].imshow(rendered_error.detach().cpu())</span>
                <span class="c1"># axes[0, 2].set_title(&quot;depth_loss&quot;)</span>
                <span class="c1"># axes[1, 2].clear()</span>
                <span class="c1"># axes[1, 2].imshow(error_pc.detach().cpu())</span>
                <span class="c1"># axes[1, 2].set_title(&quot;pointcloud_loss&quot;)</span>

                <span class="n">loss_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depth_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Depth&quot;</span><span class="p">)</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pointcloud_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pointcloud&quot;</span><span class="p">)</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nn_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nearest Neighbor&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point_constraint_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Point constraint&quot;</span><span class="p">)</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">total_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                <span class="n">loss_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                <span class="n">inlier_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">inlier_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">inlier_ratios</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inlier Ratio&quot;</span><span class="p">)</span>
                <span class="n">inlier_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">current_depth</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fig_loss</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">fig_vis</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_iteration</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_loss</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_vis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_log_data</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">animation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_animations</span><span class="p">(</span><span class="n">animation_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span> <span class="o">==</span> <span class="s2">&quot;last_iteration&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">latent_shape</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span> <span class="o">==</span> <span class="s2">&quot;best_inlier_ratio&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_orientation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_scale</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_latent_shape</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Result selection strategy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result_selection_strategy</span><span class="si">}</span><span class="s2"> is not&quot;</span>
            <span class="s2">&quot;supported.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="sdfest.estimation.simple_setup.SDFPipeline.generate_depth" class="doc doc-heading">
        <span class="doc doc-object-name doc-function-name">generate_depth</span>


</h4>
<div class="highlight"><pre><span></span><code><span class="n">generate_depth</span><span class="p">(</span>
    <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate depth image representing positioned object.</p>

      <details class="quote">
        <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_depth</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">orientation</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate depth image representing positioned object.&quot;&quot;&quot;</span>
    <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">depth</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="sdfest.estimation.simple_setup.SDFPipeline.generate_mesh" class="doc doc-heading">
        <span class="doc doc-object-name doc-function-name">generate_mesh</span>


</h4>
<div class="highlight"><pre><span></span><code><span class="n">generate_mesh</span><span class="p">(</span>
    <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">complete_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">synthetic</span><span class="o">.</span><span class="n">Mesh</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate mesh without pose.</p>
<p>Currently only supports batch size 1.</p>

  <table>
    <thead>
      <tr>
        <th><b>PARAMETER</b></th>
        <th><b>DESCRIPTION</b></th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>latent</code></td>
          <td class="doc-param-details">
            <p>Latent shape descriptor, shape (1,L).</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>torch.<span title="torch.tensor">tensor</span></code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>scale</code></td>
          <td class="doc-param-details">
            <p>Relative scale of the signed distance field, (i.e., half-width),
shape (1,).</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>torch.<span title="torch.tensor">tensor</span></code>
                </span>
            </p>
          </td>
        </tr>
        <tr>
          <td><code>complete_mesh</code></td>
          <td class="doc-param-details">
            <p>If True, the SDF will be padded with positive values prior to converting
it to a mesh. This ensures a watertight mesh is created.</p>
            <p>
                <span class="doc-param-annotation">
                  <b>TYPE:</b>
                    <code>bool</code>
                </span>
                <span class="doc-param-default">
                  <b>DEFAULT:</b> 
                    <code>False</code>
                </span>
            </p>
          </td>
        </tr>
    </tbody>
  </table>

  <table>
    <thead>
      <tr>
        <th><b>RETURNS</b></th>
        <th><b>DESCRIPTION</b></th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
              <span class="doc-returns-annotation">
                  <code><a class="autorefs autorefs-internal" title="sdfest.estimation.synthetic" href="../synthetic/#sdfest.estimation.synthetic">synthetic</a>.<a class="autorefs autorefs-internal" title="sdfest.estimation.synthetic.Mesh" href="../synthetic/#sdfest.estimation.synthetic.Mesh">Mesh</a></code>
              </span>
          </td>
          <td class="doc-returns-details">
            <p>Generate mesh by decoding latent shape descriptor and scaling it.</p>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>sdfest/estimation/simple_setup.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_mesh</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">complete_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">synthetic</span><span class="o">.</span><span class="n">Mesh</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate mesh without pose.</span>

<span class="sd">    Currently only supports batch size 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        latent: Latent shape descriptor, shape (1,L).</span>
<span class="sd">        scale:</span>
<span class="sd">            Relative scale of the signed distance field, (i.e., half-width),</span>
<span class="sd">            shape (1,).</span>
<span class="sd">        complete_mesh:</span>
<span class="sd">            If True, the SDF will be padded with positive values prior to converting</span>
<span class="sd">            it to a mesh. This ensures a watertight mesh is created.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Generate mesh by decoding latent shape descriptor and scaling it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">complete_mesh</span><span class="p">:</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span>
                <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">spacing</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;iso_threshold&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">+</span> <span class="n">inc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># move origin to center</span>
            <span class="n">vertices</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>

            <span class="n">mesh</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">TriangleMesh</span><span class="p">(</span>
                <span class="n">vertices</span><span class="o">=</span><span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span><span class="n">vertices</span><span class="p">),</span>
                <span class="n">triangles</span><span class="o">=</span><span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3iVector</span><span class="p">(</span><span class="n">faces</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">synthetic</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">rel_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../scripts/rendering_evaluation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: rendering_evaluation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              rendering_evaluation
            </div>
          </div>
        </a>
      
      
        
        <a href="../synthetic/" class="md-footer__link md-footer__link--next" aria-label="Next: synthetic" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              synthetic
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>